<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ming Zhao">
<meta name="dcterms.date" content="2023-08-12">

<title>Decomposotion Methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Decomposition Methods_files/libs/clipboard/clipboard.min.js"></script>
<script src="Decomposition Methods_files/libs/quarto-html/quarto.js"></script>
<script src="Decomposition Methods_files/libs/quarto-html/popper.min.js"></script>
<script src="Decomposition Methods_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Decomposition Methods_files/libs/quarto-html/anchor.min.js"></script>
<link href="Decomposition Methods_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Decomposition Methods_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Decomposition Methods_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Decomposition Methods_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Decomposition Methods_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#benders-decomposition" id="toc-benders-decomposition" class="nav-link active" data-scroll-target="#benders-decomposition">Benders Decomposition</a>
  <ul class="collapse">
  <li><a href="#capacitated-fixed-charge" id="toc-capacitated-fixed-charge" class="nav-link" data-scroll-target="#capacitated-fixed-charge">Capacitated Fixed-Charge</a></li>
  </ul></li>
  <li><a href="#dantzig-wolfe-decomposition" id="toc-dantzig-wolfe-decomposition" class="nav-link" data-scroll-target="#dantzig-wolfe-decomposition">Dantzig-Wolfe Decomposition</a>
  <ul class="collapse">
  <li><a href="#multicommodity-flow-problem" id="toc-multicommodity-flow-problem" class="nav-link" data-scroll-target="#multicommodity-flow-problem">Multicommodity Flow Problem</a></li>
  </ul></li>
  <li><a href="#gap" id="toc-gap" class="nav-link" data-scroll-target="#gap">GAP</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Decomposotion Methods</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ming Zhao </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 12, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="benders-decomposition" class="level1">
<h1>Benders Decomposition</h1>
<p>Suppose we have an optimization problem given by</p>
<p><span class="math display">\begin{align}
\tag{P}
\begin{array}{ll}
\min &amp; c^\intercal x + f(y)\\
\text{s.t.}    &amp; Ax + F(y) \geq b \\
&amp; x \geq 0, \ y \in Y,
\end{array}
\end{align}</span></p>
<p>where <span class="math inline">A</span> is <span class="math inline">m \times n</span>, <span class="math inline">f:\Re^q \mapsto \Re</span>, <span class="math inline">F:\Re^q \mapsto \Re^m</span> and <span class="math inline">Y \subseteq \Re^q</span>. The difficulty in this problem comes from the variable <span class="math inline">y</span> as the problem becomes a linear program for a fixed <span class="math inline">y</span>. In a typical application the set <span class="math inline">Y</span> can also be complicated set like the integrality constraints. This type of formulation also arises frequently in stochastic programming, where the decision variables <span class="math inline">y</span> are the first stage variables, and variables <span class="math inline">x</span> represent the activities in the future. As the uncertainty in the future reveals itself, the variable <span class="math inline">y</span> is altered and the corresponding expected cost, denoted as <span class="math inline">f(y)</span>, is minimized.</p>
<p>Let <span class="math inline">\mathscr{Y} = \{y \in Y: \exists x \ge 0 \text{ with } Ax \ge b - F(y)\}</span>, and <span class="math inline">\mathscr{U} = \{A^\intercal u \le c, u \ge 0\}</span>. We rewrite (P) as follows:</p>
<p><span class="math display">\begin{align*}
&amp;\min_{x, y \in Y} \bigg\{ f(y) + c^\intercal x : Ax \ge b - F(y), x \ge 0 \bigg\} \\
\stackrel{[1]}{=} &amp;\min_{y \in \color{red}{\mathscr{Y}}} \bigg\{ f(y) + \min_x \left\{ c^\intercal x: Ax \ge b - F(y), x \ge 0 \right\} \bigg\} \\
\stackrel{[2]}{=} &amp;\min_{y \in {\mathscr{Y}}} \bigg\{ f(y) + \max_u \left\{ (b - F(y))^\intercal u: A^\intercal u \le c, u \ge 0 \right\} \bigg\} \\
\stackrel{[3]}{=} &amp;\min_{y \in \mathscr{Y}} \bigg\{ f(y) + \max_{i \in K} \left\{ (b - F(y))^\intercal u^p_i \right\} \bigg\} \\
= &amp; \min \quad f(y) + z \\
&amp;  \begin{aligned}
\text{ s.t.} \quad z &amp;\ge (b - F(y))^\intercal u^p_i, &amp;&amp; i \in K \\
y &amp; \in \mathscr{Y}
\end{aligned} \\
\stackrel{[4]}{=} &amp; \min \quad f(y) + z \\
&amp;  \begin{aligned}
\text{ s.t.} \quad &amp; z \ge (b - F(y))^\intercal u^p_i, &amp;&amp; i \in K \\
&amp; \{x \in \mathcal{R}^n_{+} : Ax \ge b - F(y)\} \neq \emptyset &amp;&amp;
\end{aligned} \\
\stackrel{[5]}{=} &amp; \min \quad f(y) + z \\
&amp;  \begin{aligned}
\text{ s.t.} \quad z &amp;\ge (b - F(y))^\intercal u^p_i, &amp;&amp; i \in K \\
0 &amp; \ge (b - F(y))^\intercal v^r_i, &amp;&amp; i \in R \\
y &amp; \in Y
\end{aligned}
\end{align*}</span></p>
<ul>
<li>The equation [1] is simply a rewrite of (P). Note that <span class="math inline">y \in \mathscr{Y}</span> guarantees the feasibility of the LP on <span class="math inline">x</span>.</li>
<li>The equation [2] holds because of the LP’s duality.</li>
<li>The equation [3] holds because of <span class="math inline">u^p_i</span>, <span class="math inline">i \in K</span>, are extreme points of the polyhedral <span class="math inline">\mathscr{U}</span>.</li>
<li>The equation [4] follows the definition of <span class="math inline">\mathscr{Y}</span>, which indicates that <span class="math inline">y \in \mathscr{Y}</span> is equivalent to <span class="math inline">\{x \in \mathcal{R}^n_{+} : Ax \ge b - F(y)\} \neq \emptyset</span>.</li>
<li>The equation [5] holds because by the Farkas’ Lemma, <span class="math display">\begin{align*}
\{x \in \mathcal{R}^n_{+} : Ax \ge b - F(y)\} \neq \emptyset \Leftrightarrow \ &amp; \text{$(b-F(y))^\intercal v \le 0$ for all $v \in \Re_+^m $ that $ A^\intercal v \le 0$} \\
\Leftrightarrow \ &amp; \text{$(b-F(y))^\intercal v \le 0$ for all extreme ray $v$ of the polyhedral cone $\{v \in \Re_+^m : A^\intercal v \le 0\}$} \\
\Leftrightarrow \ &amp; \text{$(b-F(y))^\intercal v^r_i \le 0$ where $v^r_i$, $i \in R$, are extreme rays of $\mathscr{U}$}
\end{align*}</span></li>
</ul>
<section id="capacitated-fixed-charge" class="level2">
<h2 class="anchored" data-anchor-id="capacitated-fixed-charge">Capacitated Fixed-Charge</h2>
<p>We consider a capacitated fixed-charge problem with 4 suppliers and 8 customers as shown in the figure</p>
<p><img src="https://raw.githubusercontent.com/ming-zhao/ming-zhao.github.io/master/intro_to_analytics/res/decomposition/figure/capacitated_fixed_charge.png" width="300"></p>
<p>The mathematical model is:</p>
<p><span class="math display">\begin{align*}
\min \ &amp; \sum_{j \in S} f_j y_j + \sum_{i \in C, j \in S} t_{ij} x_{ij} \\
\text{s.t.}\ &amp; \sum_{j \in S} x_{ij} = d_i, \ \forall i \in C, \\
&amp; \sum_{i \in C} x_{ij} \le c_j y_j, \ \forall j \in S, \\
&amp; ~~ x_{ij} \ge 0,\ y_j \in \{0,1\}
\end{align*}</span></p>
<p>We have</p>
<table class="table">
<colgroup>
<col style="width: 36%">
<col style="width: 36%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Master Problem (Initial)</th>
<th style="text-align: center;">Subproblem (Primal)</th>
<th>Subproblem (Dual)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">\begin{align*}
\min \ &amp; \sum_{j \in S} f_j y_j + z \\
\text{s.t.}\ &amp; \sum_{j \in S} c_j y_j \ge \sum_{i \in C} d_i \\
&amp; ~~ \ y_j \in \{0,1\}
\end{align*}</span></td>
<td style="text-align: center;"><span class="math display">\begin{align*}
\min \ &amp; \sum_{i \in C, j \in S} t_{ij} x_{ij} \\
\text{s.t.}\ &amp; \sum_{j \in S} x_{ij} = d_i, \ \forall i \in C \\
&amp; \sum_{i \in C} x_{ij} \le c_j y_j, \ \forall j \in S \\
&amp; ~~ x_{ij} \ge 0,
\end{align*}</span></td>
<td><span class="math display">\begin{align*}
\max \ &amp; \sum_{i \in C} d_{i} u_{i} - \sum_{j \in S} c_j y_j v_j \\
\text{s.t.}\ &amp; u_i - v_j \le t_{ij},\ \forall i \in C, j \in S \\
&amp; v_j \ge 0
\end{align*}</span></td>
</tr>
</tbody>
</table>
<p>and the restricted Benders master problem <span class="math display">\begin{align*}
\min \ &amp; \sum_{j \in S} f_j y_j + z \\
\text{s.t.}\ &amp; \sum_{j \in S} c_j y_j \ge \sum_{i \in C} d_i \\
&amp; \sum_{i \in C} d_{i} u^i_{i} - \sum_{j \in S} c_j y_j v^i_j \le z,\ \forall i \in \bar{K}  &amp;&amp; \text{optimality cuts} \\
&amp; \sum_{i \in C} d_{i} u^r_{i} - \sum_{j \in S} c_j y_j v^r_j \le 0,\ \forall r \in \bar{R} &amp;&amp; \text{feasibility cuts} \\
&amp; \ y_j \in \{0,1\}
\end{align*}</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The constraint in the master problem, used capacity greater or equal to total demand, is not necessary, but it helps to tight the LP relaxation.</p>
<p>Without this constraint, we will get <span class="math inline">y_j = 0</span> as the optimal solution in the first iteration. This solution will cause the subproblem infeasible (or unbounded for the dual problem), and feasibility cut is required to be added into the master problem.</p>
<p>The direct formulation of the dual is</p>
<p><span class="math display">\begin{align*}
\max \ &amp; \sum_{i \in C} d_{i} u_{i} + \sum_{j \in S} c_j y_j v_j \\
\text{s.t.}\ &amp; u_i + v_j \le t_{ij}, \ \forall i \in C, j \in S \\
&amp; v_j \le 0
\end{align*}</span></p>
<p>This is the dual of the primal problem used in Gurobi. We formulate the dual problem by substitute <span class="math inline">-v_j</span> as <span class="math inline">v_j</span>. Hence, we need to add negative sign in the implementation after we solve the primal and obtain the dual solution.</p>
</div>
</div>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gurobipy <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">'ticks'</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.dpi'</span>] <span class="op">=</span> <span class="dv">70</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>fixed_cost <span class="op">=</span> {<span class="st">'S1'</span>:<span class="dv">4500</span>, <span class="st">'S2'</span>:<span class="dv">4400</span>, <span class="st">'S3'</span>:<span class="dv">4250</span>, <span class="st">'S4'</span>:<span class="dv">4250</span>}</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>capacity   <span class="op">=</span> {<span class="st">'S1'</span>:<span class="dv">600</span>,  <span class="st">'S2'</span>:<span class="dv">700</span>,  <span class="st">'S3'</span>:<span class="dv">500</span>,  <span class="st">'S4'</span>:<span class="dv">550</span>}</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>demand     <span class="op">=</span> {<span class="st">'D1'</span>:<span class="dv">100</span>,  <span class="st">'D2'</span>:<span class="dv">150</span>,  <span class="st">'D3'</span>:<span class="dv">175</span>,  <span class="st">'D4'</span>:<span class="dv">125</span>, </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>              <span class="st">'D5'</span>:<span class="dv">180</span>,  <span class="st">'D6'</span>:<span class="dv">140</span>,  <span class="st">'D7'</span>:<span class="dv">120</span>,  <span class="st">'D8'</span>:<span class="dv">160</span>}</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>trans_cost <span class="op">=</span> [<span class="dv">26</span>, <span class="dv">27</span>, <span class="dv">28</span>, <span class="dv">17</span>, <span class="dv">13</span>, <span class="dv">19</span>, <span class="dv">21</span>, <span class="dv">19</span>, <span class="dv">19</span>, <span class="dv">22</span>, <span class="dv">12</span>, </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>              <span class="dv">26</span>, <span class="dv">11</span>, <span class="dv">22</span>, <span class="dv">22</span>, <span class="dv">24</span>, <span class="dv">17</span>, <span class="dv">15</span>, <span class="dv">13</span>, <span class="dv">15</span>, <span class="dv">25</span>, <span class="dv">26</span>, </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>              <span class="dv">27</span>, <span class="dv">23</span>, <span class="dv">20</span>, <span class="dv">19</span>, <span class="dv">23</span>, <span class="dv">26</span>, <span class="dv">21</span>, <span class="dv">16</span>, <span class="dv">23</span>, <span class="dv">26</span>]</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>suppliers <span class="op">=</span> <span class="bu">list</span>(fixed_cost.keys())</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>customers <span class="op">=</span> <span class="bu">list</span>(demand.keys())</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>trans_cost <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>([(i,j) <span class="cf">for</span> i <span class="kw">in</span> customers <span class="cf">for</span> j <span class="kw">in</span> suppliers],trans_cost))</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># np.array(list(trans_cost.values())).reshape(len(customers), -1).T</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> Model()</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> m.addVars(suppliers, vtype<span class="op">=</span>GRB.BINARY, name<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> m.addVars(customers, suppliers, vtype<span class="op">=</span>GRB.CONTINUOUS, name<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>m.setObjective(<span class="bu">sum</span>(fixed_cost[j]<span class="op">*</span>y[j] <span class="cf">for</span> j <span class="kw">in</span> suppliers) <span class="op">+</span> </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>               <span class="bu">sum</span>(trans_cost[i,j]<span class="op">*</span>x[i,j] <span class="cf">for</span> i <span class="kw">in</span> customers <span class="cf">for</span> j <span class="kw">in</span> suppliers))</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> customers:</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    m.addConstr(<span class="bu">sum</span>(x[i,j] <span class="cf">for</span> j <span class="kw">in</span> suppliers) <span class="op">==</span> demand[i])</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> suppliers:</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    m.addConstr(<span class="bu">sum</span>(x[i,j] <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">&lt;=</span> capacity[j]<span class="op">*</span>y[j])</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># m.Params.OutputFlag = 0</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>m.optimize()</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>m.Params.OutputFlag <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>m.printAttr(<span class="st">'X'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Set parameter Username
Academic license - for non-commercial use only - expires 2023-11-04
Gurobi Optimizer version 9.5.2 build v9.5.2rc0 (win64)
Thread count: 8 physical cores, 16 logical processors, using up to 16 threads
Optimize a model with 12 rows, 36 columns and 68 nonzeros
Model fingerprint: 0x5385f77b
Variable types: 32 continuous, 4 integer (4 binary)
Coefficient statistics:
  Matrix range     [1e+00, 7e+02]
  Objective range  [1e+01, 5e+03]
  Bounds range     [1e+00, 1e+00]
  RHS range        [1e+02, 2e+02]
Presolve time: 0.01s
Presolved: 12 rows, 36 columns, 68 nonzeros
Variable types: 32 continuous, 4 integer (4 binary)
Found heuristic solution: objective 34925.000000

Root relaxation: objective 2.618097e+04, 7 iterations, 0.00 seconds (0.00 work units)

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0 26180.9740    0    4 34925.0000 26180.9740  25.0%     -    0s
H    0     0                    29280.000000 26180.9740  10.6%     -    0s
     0     0 28490.0000    0    3 29280.0000 28490.0000  2.70%     -    0s
     0     0 29280.0000    0    2 29280.0000 29280.0000  0.00%     -    0s

Cutting planes:
  Gomory: 2
  Implied bound: 4

Explored 1 nodes (19 simplex iterations) in 0.08 seconds (0.00 work units)
Thread count was 16 (of 16 available processors)

Solution count 2: 29280 34925 

Optimal solution found (tolerance 1.00e-04)
Best objective 2.928000000000e+04, best bound 2.928000000000e+04, gap 0.0000%

    Variable            X 
-------------------------
       y[S1]            1 
       y[S2]            1 
    x[D1,S1]           10 
    x[D1,S2]           90 
    x[D2,S1]          150 
    x[D3,S1]          175 
    x[D4,S1]          125 
    x[D5,S2]          180 
    x[D6,S1]          140 
    x[D7,S2]          120 
    x[D8,S2]          160 </code></pre>
</div>
</div>
<p>The lazy constraint callback will add lazy cut for any MIP solution found during the branch-and-bound tree. Hence, the list of objective value is not necessary monotonic.</p>
<div class="cell" data-execution_count="53">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>master <span class="op">=</span> Model()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> master.addVars(suppliers, vtype<span class="op">=</span>GRB.BINARY, name<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> master.addVar(vtype<span class="op">=</span>GRB.CONTINUOUS, name<span class="op">=</span><span class="st">'z'</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>master.setObjective(<span class="bu">sum</span>(fixed_cost[j]<span class="op">*</span>y[j] <span class="cf">for</span> j <span class="kw">in</span> suppliers) <span class="op">+</span> z)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># master.addConstr(sum(capacity[j]*y[j] for j in suppliers) &gt;= sum(demand[i] for i in customers))</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># _vars is used in callback function</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>master._vars <span class="op">=</span> {<span class="st">'y'</span>: y, <span class="st">'z'</span>: z}</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># primal formulation of the subproblem</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>subP <span class="op">=</span> Model()</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> subP.addVars(customers, suppliers, vtype<span class="op">=</span>GRB.CONTINUOUS, name<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>subP.setObjective(<span class="bu">sum</span>(trans_cost[i,j]<span class="op">*</span>x[i,j] <span class="cf">for</span> i <span class="kw">in</span> customers <span class="cf">for</span> j <span class="kw">in</span> suppliers))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> customers:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    subP.addConstr(<span class="bu">sum</span>(x[i,j] <span class="cf">for</span> j <span class="kw">in</span> suppliers) <span class="op">==</span> demand[i], <span class="ss">f"d[</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">]"</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> suppliers:</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    subP.addConstr(<span class="bu">sum</span>(x[i,j] <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">&lt;=</span> capacity[j]<span class="op">*</span><span class="dv">1</span>, <span class="ss">f"c[</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">]"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>subP.Params.InfUnbdInfo <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># have to update (otherwise empty) so that we can get constr and its rhs later in</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   subP.getConstrByName(f"c[{j}]").RHS</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>subP.update()</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># dual formulation of the subproblem</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>subD <span class="op">=</span> Model()</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> subD.addVars(customers, lb<span class="op">=-</span><span class="fl">1e20</span>, ub<span class="op">=</span><span class="fl">1e20</span>, vtype<span class="op">=</span>GRB.CONTINUOUS, name<span class="op">=</span><span class="st">'u'</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>v <span class="op">=</span> subD.addVars(suppliers, vtype<span class="op">=</span>GRB.CONTINUOUS, name<span class="op">=</span><span class="st">'v'</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> customers:</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> suppliers:</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        subD.addConstr(u[i] <span class="op">-</span> v[j] <span class="op">&lt;=</span> trans_cost[i,j])</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>subD.Params.InfUnbdInfo <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>master.Params.OutputFlag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>subP.Params.OutputFlag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>subD.Params.OutputFlag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> benders():</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    objs <span class="op">=</span> []</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    niter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    _USE_SUB_PRIMAL <span class="op">=</span> <span class="va">True</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        master.optimize()</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>        objs.append(master.objVal)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> _USE_SUB_PRIMAL:</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> suppliers:</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>                subP.getConstrByName(<span class="ss">f"c[</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">]"</span>).RHS <span class="op">=</span> capacity[j]<span class="op">*</span>y[j].x</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>            subP.optimize()</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> subP.status <span class="op">==</span> GRB.INFEASIBLE:</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>                u_ray <span class="op">=</span> <span class="bu">dict</span>([(i, <span class="op">-</span>subP.getConstrByName(<span class="ss">f"d[</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">]"</span>).FarkasDual) <span class="cf">for</span> i <span class="kw">in</span> customers])</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>                v_ray <span class="op">=</span> <span class="bu">dict</span>([(j, subP.getConstrByName(<span class="ss">f"c[</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">]"</span>).FarkasDual) <span class="cf">for</span> j <span class="kw">in</span> suppliers])</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>                exp <span class="op">=</span> LinExpr(<span class="bu">sum</span>(demand[i]<span class="op">*</span>u_ray[i] <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">-</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>                              <span class="bu">sum</span>(capacity[j]<span class="op">*</span>y[j]<span class="op">*</span>v_ray[j] <span class="cf">for</span> j <span class="kw">in</span> suppliers))</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>                master.addConstr(exp <span class="op">&lt;=</span> <span class="dv">0</span>) </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> subP.status <span class="op">==</span> GRB.OPTIMAL:</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>                u_ext <span class="op">=</span> <span class="bu">dict</span>([(i, subP.getConstrByName(<span class="ss">f"d[</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">]"</span>).Pi) <span class="cf">for</span> i <span class="kw">in</span> customers])</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>                v_ext <span class="op">=</span> <span class="bu">dict</span>([(j, <span class="op">-</span>subP.getConstrByName(<span class="ss">f"c[</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">]"</span>).Pi) <span class="cf">for</span> j <span class="kw">in</span> suppliers])</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>                exp <span class="op">=</span> LinExpr(<span class="bu">sum</span>(demand[i]<span class="op">*</span>u_ext[i] <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">-</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>                              <span class="bu">sum</span>(capacity[j]<span class="op">*</span>y[j]<span class="op">*</span>v_ext[j] <span class="cf">for</span> j <span class="kw">in</span> suppliers))</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> exp.getValue() <span class="op">&gt;</span> z.x:</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>                    master.addConstr(exp <span class="op">&lt;=</span> z) </span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span>    </span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>            subD.setObjective(<span class="bu">sum</span>(demand[i]<span class="op">*</span>u[i] <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">-</span> </span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>                              <span class="bu">sum</span>(capacity[j]<span class="op">*</span>y[j].x<span class="op">*</span>v[j] <span class="cf">for</span> j <span class="kw">in</span> suppliers), GRB.MAXIMIZE)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>            subD.optimize()</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> subD.status <span class="op">==</span> GRB.UNBOUNDED:</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>                master.addConstr(<span class="bu">sum</span>(demand[i]<span class="op">*</span>u[i].unbdray <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">-</span> </span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>                                 <span class="bu">sum</span>(capacity[j]<span class="op">*</span>y[j]<span class="op">*</span>v[j].unbdray <span class="cf">for</span> j <span class="kw">in</span> suppliers) <span class="op">&lt;=</span> <span class="dv">0</span>)</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> subD.status <span class="op">==</span> GRB.OPTIMAL:</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>                exp <span class="op">=</span> LinExpr(<span class="bu">sum</span>(demand[i]<span class="op">*</span>u[i].x <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">-</span> </span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>                              <span class="bu">sum</span>(capacity[j]<span class="op">*</span>y[j]<span class="op">*</span>v[j].x <span class="cf">for</span> j <span class="kw">in</span> suppliers))</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> exp.getValue() <span class="op">&gt;</span> z.x:</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>                    master.addConstr(exp <span class="op">&lt;=</span> z) </span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span>        </span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     if subP.status == GRB.INFEASIBLE:            </span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         print([u[i].unbdray for i in customers])</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         print([v[j].unbdray for j in suppliers])</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         print([subP.getConstrByName(f"d[{i}]").FarkasDual for i in customers])</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         print([subP.getConstrByName(f"c[{j}]").FarkasDual for j in suppliers])</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     if subP.status == GRB.OPTIMAL:</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         print([u[i].x for i in customers])</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         print([v[j].x for j in suppliers])</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         print([subP.getConstrByName(f"d[{i}]").Pi for i in customers])</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         print([subP.getConstrByName(f"c[{j}]").Pi for j in suppliers])</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>        niter <span class="op">=</span> niter <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> objs</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>niter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>objs <span class="op">=</span> []</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cbbenders(model, where):</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> niter</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> where <span class="op">==</span> GRB.Callback.MIPSOL:</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('-'*8 + " MIP sol callback: {} ".format(niter) + '-'*8)</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>        obj <span class="op">=</span> model.cbGet(GRB.Callback.MIPSOL_OBJ)</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>        objs.append(<span class="bu">round</span>(obj))</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>        y_val <span class="op">=</span> model.cbGetSolution(model._vars[<span class="st">'y'</span>])</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>        z_val <span class="op">=</span> model.cbGetSolution(model._vars[<span class="st">'z'</span>])</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>        subD.setObjective(<span class="bu">sum</span>(demand[i]<span class="op">*</span>u[i] <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">-</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>                          <span class="bu">sum</span>(capacity[j]<span class="op">*</span>y_val[j]<span class="op">*</span>v[j] <span class="cf">for</span> j <span class="kw">in</span> suppliers), GRB.MAXIMIZE)</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>        <span class="co"># turn on option to query unbounded ray</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>        subD.Params.InfUnbdInfo <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>        subD.update()</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>        subD.optimize()</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> subD.status <span class="op">==</span> GRB.UNBOUNDED:</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>            master.cbLazy(<span class="bu">sum</span>(demand[i]<span class="op">*</span>u[i].unbdray <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">-</span> </span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>                             <span class="bu">sum</span>(capacity[j]<span class="op">*</span>model._vars[<span class="st">'y'</span>][j]<span class="op">*</span>v[j].unbdray <span class="cf">for</span> j <span class="kw">in</span> suppliers) <span class="op">&lt;=</span> <span class="dv">0</span>)</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> subD.status <span class="op">==</span> GRB.OPTIMAL:</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>            rhs <span class="op">=</span> (<span class="bu">sum</span>(demand[i]<span class="op">*</span>u[i].x <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">-</span> </span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>                   <span class="bu">sum</span>(capacity[j]<span class="op">*</span>y_val[j]<span class="op">*</span>v[j].x <span class="cf">for</span> j <span class="kw">in</span> suppliers))</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> rhs <span class="op">&gt;</span> z_val:</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>                master.cbLazy(<span class="bu">sum</span>(demand[i]<span class="op">*</span>u[i].x <span class="cf">for</span> i <span class="kw">in</span> customers) <span class="op">-</span> </span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>                              <span class="bu">sum</span>(capacity[j]<span class="op">*</span>model._vars[<span class="st">'y'</span>][j]<span class="op">*</span>v[j].x <span class="cf">for</span> j <span class="kw">in</span> suppliers) <span class="op">&lt;=</span> model._vars[<span class="st">'z'</span>]) </span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>        niter <span class="op">=</span> niter<span class="op">+</span><span class="dv">1</span></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print('-'*8 + " MIP sol callback: End " + '-'*8)</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>master.Params.lazyConstraints <span class="op">=</span> <span class="dv">1</span> </span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a><span class="co"># master.Params.PreCrush = 1</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a><span class="co"># master.Params.Threads = 1</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct Implementation</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a><span class="co"># benders()</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a><span class="co"># Lazy Constraint</span></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>master.Params.OutputFlag <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>master.optimize(cbbenders)</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(objs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Set parameter InfUnbdInfo to value 1
Set parameter InfUnbdInfo to value 1
Set parameter OutputFlag to value 1
Gurobi Optimizer version 9.5.2 build v9.5.2rc0 (win64)
Thread count: 8 physical cores, 16 logical processors, using up to 16 threads
Optimize a model with 0 rows, 5 columns and 0 nonzeros
Model fingerprint: 0xd1b1e689
Variable types: 1 continuous, 4 integer (4 binary)
Coefficient statistics:
  Matrix range     [0e+00, 0e+00]
  Objective range  [1e+00, 5e+03]
  Bounds range     [1e+00, 1e+00]
  RHS range        [0e+00, 0e+00]
Presolve time: 0.00s
Presolved: 0 rows, 5 columns, 0 nonzeros
Variable types: 1 continuous, 4 integer (4 binary)

Root relaxation: objective 7.861538e+03, 1 iterations, 0.00 seconds (0.00 work units)

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0 7861.53846    0    1          - 7861.53846      -     -    0s
H    0     0                    30560.000000 7861.53846  74.3%     -    0s
H    0     0                    29280.000000 7861.53846  73.2%     -    0s
     0     0 22620.2509    0    2 29280.0000 22620.2509  22.7%     -    0s
     0     0 25361.1345    0    4 29280.0000 25361.1345  13.4%     -    0s
     0     0 25687.3911    0    4 29280.0000 25687.3911  12.3%     -    0s
     0     0 25717.6280    0    4 29280.0000 25717.6280  12.2%     -    0s
     0     0 25890.4329    0    4 29280.0000 25890.4329  11.6%     -    0s
     0     0 25908.8205    0    4 29280.0000 25908.8205  11.5%     -    0s
     0     0 25993.6985    0    4 29280.0000 25993.6985  11.2%     -    0s
     0     0 25995.8961    0    4 29280.0000 25995.8961  11.2%     -    0s
     0     0 26086.8822    0    4 29280.0000 26086.8822  10.9%     -    0s
     0     0 26219.4737    0    4 29280.0000 26219.4737  10.5%     -    0s
     0     0 26222.6884    0    4 29280.0000 26222.6884  10.4%     -    0s
     0     0 26334.1892    0    4 29280.0000 26334.1892  10.1%     -    0s
     0     0 26335.7739    0    4 29280.0000 26335.7739  10.1%     -    0s
     0     0 26375.6269    0    4 29280.0000 26375.6269  9.92%     -    0s
     0     0 26377.0966    0    4 29280.0000 26377.0966  9.91%     -    0s
     0     0 26377.3105    0    4 29280.0000 26377.3105  9.91%     -    0s
     0     0 26396.4657    0    4 29280.0000 26396.4657  9.85%     -    0s
     0     0 26400.7512    0    4 29280.0000 26400.7512  9.83%     -    0s
     0     2 26400.7512    0    4 29280.0000 26400.7512  9.83%     -    0s

Cutting planes:
  MIR: 4
  Lazy constraints: 7

Explored 9 nodes (49 simplex iterations) in 0.03 seconds (0.00 work units)
Thread count was 16 (of 16 available processors)

Solution count 2: 29280 30560 

Optimal solution found (tolerance 1.00e-04)
Best objective 2.928000000000e+04, best bound 2.928000000000e+04, gap 0.0000%

User-callback calls 186, time in user-callback 0.01 sec
[0, 0, 0, 0, 0, 8650, 30560, 24210, 29280, 26251, 25630, 28460, 27860]</code></pre>
</div>
</div>
</section>
</section>
<section id="dantzig-wolfe-decomposition" class="level1">
<h1>Dantzig-Wolfe Decomposition</h1>
<section id="multicommodity-flow-problem" class="level2">
<h2 class="anchored" data-anchor-id="multicommodity-flow-problem">Multicommodity Flow Problem</h2>
<center>
<img src="https://raw.githubusercontent.com/ming-zhao/ming-zhao.github.io/master/intro_to_analytics/res/decomposition/figure/images_mcf.png" width="400">
</center>
<p><span class="math display">\begin{align}
&amp;\text{minimize} &amp;\sum_{k \in K} \sum_{(i,j) \in A} c_{ij}^k x_{ij}^k \nonumber \\
&amp;\text{subject to} &amp;\sum_{k \in K} x_{ij}^k &amp;\le u_{ij} &amp;&amp; (i,j) \in A \nonumber \\
&amp;&amp;\sum_{(i,j) \in A} x_{ij}^k - \sum_{(j,i) \in A} x_{ji}^k &amp;= b_i^k &amp;&amp; i \in N,\ k \in K \\
&amp;&amp; 0 \le x_{ij}^k &amp;\le u_{ij}^k &amp;&amp; (i,j) \in A,\ k \in K
\end{align}</span></p>
<div class="callout callout-style-default callout-note callout-titled" title="Matrix Form">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Matrix Form
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The matrix form of the constraints is:</p>
<p><span class="math display">\begin{equation*}
\scriptsize
\left(
\begin{array} {rrrrrrr|rrrrrrr}
x^1_{12}    &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   x^2_{12}    &amp;   &amp;   &amp;   &amp;   &amp;   \\
&amp;   x^1_{13}    &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   x^2_{13}    &amp;   &amp;   &amp;   &amp;   \\
&amp;   &amp;   x^1_{53}    &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   x^2_{53}    &amp;   &amp;   &amp;   \\
&amp;   &amp;   &amp;   x^1_{56}    &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   x^2_{56}    &amp;   &amp;   \\
&amp;   &amp;   &amp;   &amp;   x^1_{34}    &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   x^2_{34}    &amp;   \\
&amp;   &amp;   &amp;   &amp;   &amp;   x^1_{24}    &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   x^2_{24}&amp;   \\
&amp;   &amp;   &amp;   &amp;   &amp;   &amp;   x^1_{46}    &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   x^2_{46}\\
\hline  
x^1_{12} &amp;  x^1_{13} &amp;    &amp;    &amp;    &amp;    &amp; \\
-x^1_{12} &amp;    &amp;    &amp;    &amp;    &amp; -x^1_{24} &amp; \\
&amp; -x^1_{13} &amp; -x^1_{53} &amp;    &amp;  x^1_{34} &amp;    &amp; \\
&amp;    &amp;    &amp;    &amp; -x^1_{34} &amp;  x^1_{24} &amp;  x^1_{46} \\
&amp;    &amp;  x^1_{53} &amp;  x^1_{56} &amp;    &amp;    &amp; \\
&amp;    &amp;    &amp; -x^1_{56} &amp;    &amp;    &amp; -x^1_{46} \\
\hline
&amp;&amp;  &amp;   &amp;   &amp;   &amp;   &amp;   x^2_{12}    &amp;   x^2_{13}    &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
&amp;&amp;  &amp;   &amp;   &amp;   &amp;   &amp;   -x^2_{12}   &amp;   &amp;   &amp;   &amp;   &amp;   -x^2_{24}   &amp;   &amp;   \\
&amp;&amp;  &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   -x^2_{13}   &amp;   -x^2_{53}   &amp;   &amp;   x^2_{34}    &amp;   &amp;   \\
&amp;&amp;  &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   -x^2_{34}   &amp;   x^2_{24}    &amp;   x^2_{46}    \\
&amp;&amp;  &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   x^2_{53}    &amp;   x^2_{56}    &amp;   &amp;   &amp;   &amp;   \\
&amp;&amp;  &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   -x^2_{56}   &amp;   &amp;   &amp;   -x^2_{46}   &amp;
\end{array}
\right)
\end{equation*}</span></p>
<p>The coefficient matrix is <span class="math display">\begin{equation*}
\left(
\begin{array} {rrrrrrr|rrrrrrr}
1 &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;  1 \\
&amp;  1 &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;  1 \\
&amp;    &amp;  1 &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;  1 \\
&amp;    &amp;    &amp;  1 &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;  1 \\
&amp;    &amp;    &amp;    &amp;  1 &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;  1 \\
&amp;    &amp;    &amp;    &amp;    &amp;  1 &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;  1 \\
&amp;    &amp;    &amp;    &amp;    &amp;    &amp;  1 &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;  1 \\
\hline  
1 &amp;  1 &amp;    &amp;    &amp;    &amp;    &amp; \\
-1 &amp;    &amp;    &amp;    &amp;    &amp; -1 &amp; \\
&amp; -1 &amp; -1 &amp;    &amp;  1 &amp;    &amp; \\
&amp;    &amp;    &amp;    &amp; -1 &amp;  1 &amp;  1 \\
&amp;    &amp;  1 &amp;  1 &amp;    &amp;    &amp; \\
&amp;    &amp;    &amp; -1 &amp;    &amp;    &amp; -1 \\
\hline
&amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;  1 &amp;  1 \\
&amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp; -1 &amp;    &amp;    &amp;    &amp;    &amp; -1 \\
&amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp; -1 &amp; -1 &amp;    &amp;  1 \\
&amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp; -1 &amp;  1 &amp;  1 \\
&amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;  1 &amp;  1 \\
&amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp;    &amp; -1 &amp;    &amp;    &amp; -1
\end{array}
\right)
\end{equation*}</span></p>
</div>
</div>
</div>
<p><span class="math display">\begin{equation*}
\begin{pmatrix}
A_1 &amp; A_2 &amp; \cdots &amp; A_{|K|} \\
\hline
B_1 &amp;  &amp;  &amp;  \\
&amp; B_2 &amp;  &amp;  \\
&amp; &amp; \ddots &amp;  \\
&amp; &amp; &amp; B_{|K|}
\end{pmatrix}
\end{equation*}</span></p>
<p>The Multicommodity Flow Problem can be formulated as follows: <span class="math display">\begin{align*}
&amp;\text{minimize} &amp;\sum_{k \in K} \mathbf{c}^k \mathbf{x}^k \nonumber \\
&amp;\text{subject to} &amp;\sum_{k \in K} (\mathbf{x}^k)_{ij} &amp;\le u_{ij} &amp;&amp; (i,j) \in A \\
&amp;&amp;\mathbf{x}^k &amp;\in X^k &amp;&amp; k \in K
\end{align*}</span></p>
<p>where <span class="math inline">X^k = \{\mathbf{x}^k \in \mathbb{R}^{|A|}: \text{$\mathbf{x}^k$ satisfies (1)-(2)}\}</span>. Let <span class="math inline">\left\{\mathbf{x}_p^k\right\}_{p \in P^k}</span> be all extreme points of <span class="math inline">X^k</span> (where <span class="math inline">p</span> stands for a proposal). We have <span class="math display">\begin{align*}
\mathbf{x}^k \in X^k \Leftrightarrow \mathbf{x}^k = \sum\limits_{p \in P^k} \lambda_p^k \mathbf{x}_p^k, \sum\limits_{p \in P^k} \lambda_p^k = 1, \lambda_p^k \ge 0
\end{align*}</span></p>
<p>Similarly, - <span class="math inline">c_p^k = \mathbf{c}^k \mathbf{x}_p^k</span> is cost of proposal <span class="math inline">p \in P^k</span> - <span class="math inline">f_{pij}^k = (\mathbf{x}_p^k)_{ij}</span> is flow of commodity <span class="math inline">k</span> along <span class="math inline">(i,j)</span> for <span class="math inline">p \in P^k</span></p>
<p>The Multicommodity Flow Problem can be formulated as follows: <span class="math display">\begin{align*}
\text{minimize} &amp;\sum_{k \in K} \sum_{p \in P^k} c_p^k \lambda_p^k \nonumber \\
\text{subject to} &amp;\sum_{k \in K} \sum_{p \in P^k} f^k_{pij} \lambda_p^k \le u_{ij} &amp;&amp; (i,j) \in A &amp;&amp; (v_{ij} \le 0)\\
&amp;\sum_{p \in P^k} \lambda_p^k = 1 &amp;&amp; k \in K &amp;&amp; (\text{$w_k$ free})\\
&amp;\lambda_p^k \ge 0 &amp;&amp; k \in K,\ p \in P^k
\end{align*}</span></p>
<p><img src="https://raw.githubusercontent.com/ming-zhao/ming-zhao.github.io/master/intro_to_analytics/res/decomposition/figure/images_mcf_sol.png" width="400"></p>
<div class="cell" data-execution_count="64">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Base data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>commodities <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>arcs, capacity <span class="op">=</span> multidict({</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">2</span>): <span class="dv">5</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">3</span>): <span class="dv">30</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>, <span class="dv">4</span>): <span class="dv">10</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span>, <span class="dv">2</span>): <span class="dv">30</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span>, <span class="dv">6</span>): <span class="dv">30</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">5</span>, <span class="dv">3</span>): <span class="dv">30</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">5</span>, <span class="dv">6</span>): <span class="dv">30</span>})</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Cost for triplets commodity-source-destination</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>cost <span class="op">=</span> {</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>): <span class="dv">1</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>): <span class="dv">5</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">3</span>): <span class="dv">1</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">6</span>): <span class="dv">5</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">4</span>): <span class="dv">1</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">2</span>): <span class="dv">5</span>,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">6</span>): <span class="dv">1</span>,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>): <span class="dv">1</span>,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>): <span class="dv">5</span>,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">3</span>): <span class="dv">1</span>,</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">6</span>): <span class="dv">5</span>,</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>): <span class="dv">1</span>,</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">2</span>): <span class="dv">5</span>,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>): <span class="dv">1</span>}</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Supply for pairs of commodity-node</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>outflow <span class="op">=</span> {</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">1</span>):  <span class="dv">10</span>,</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">2</span>): <span class="op">-</span><span class="dv">10</span>,</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">3</span>):  <span class="dv">0</span>,</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">4</span>):  <span class="dv">0</span>,</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">5</span>):  <span class="dv">0</span>,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">6</span>):  <span class="dv">0</span>,</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">1</span>):  <span class="dv">0</span>,</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">2</span>):  <span class="dv">0</span>,</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">3</span>):  <span class="dv">0</span>,</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">4</span>):  <span class="dv">0</span>,</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">5</span>):  <span class="dv">20</span>,</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">6</span>): <span class="op">-</span><span class="dv">20</span>}</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> Model()</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> m.addVars(commodities, arcs, obj<span class="op">=</span>cost, name<span class="op">=</span><span class="st">"flow"</span>)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Arc-capacity constraints</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>m.addConstrs(</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    (x.<span class="bu">sum</span>(<span class="st">'*'</span>, i, j) <span class="op">&lt;=</span> capacity[i, j] <span class="cf">for</span> i, j <span class="kw">in</span> arcs), <span class="st">"cap"</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Flow-conservation constraints</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>m.addConstrs(</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    (x.<span class="bu">sum</span>(k, i, <span class="st">'*'</span>) <span class="op">-</span> x.<span class="bu">sum</span>(k, <span class="st">'*'</span>, i) <span class="op">==</span> outflow[k, i]</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> commodities <span class="cf">for</span> i <span class="kw">in</span> nodes), <span class="st">"node"</span>)</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>m.optimize()</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="co"># m.write('test.lp')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Gurobi Optimizer version 9.5.2 build v9.5.2rc0 (win64)
Thread count: 8 physical cores, 16 logical processors, using up to 16 threads
Optimize a model with 19 rows, 14 columns and 42 nonzeros
Model fingerprint: 0xa507224a
Coefficient statistics:
  Matrix range     [1e+00, 1e+00]
  Objective range  [1e+00, 5e+00]
  Bounds range     [0e+00, 0e+00]
  RHS range        [5e+00, 3e+01]
Presolve removed 19 rows and 14 columns
Presolve time: 0.00s
Presolve: All rows and columns removed
Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0    1.5000000e+02   0.000000e+00   0.000000e+00      0s

Solved in 0 iterations and 0.00 seconds (0.00 work units)
Optimal objective  1.500000000e+02</code></pre>
</div>
</div>
<div class="cell" data-execution_count="59">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>master <span class="op">=</span> Model()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>excess <span class="op">=</span> master.addVar(<span class="fl">0.0</span>, GRB.INFINITY, <span class="fl">0.0</span>, GRB.CONTINUOUS)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>master.addConstrs((<span class="op">-</span>excess <span class="op">&lt;=</span> capacity[i,j] <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs), <span class="st">"multi"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>master.addConstr(<span class="dv">0</span><span class="op">*</span>excess <span class="op">==</span> <span class="dv">1</span>, <span class="st">"convex"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>sub <span class="op">=</span> Model()</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> sub.addVars(commodities, arcs, vtype<span class="op">=</span>GRB.CONTINUOUS, name<span class="op">=</span><span class="st">"flow"</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>sub.addConstrs((x.<span class="bu">sum</span>(k, i, <span class="st">'*'</span>) <span class="op">-</span> x.<span class="bu">sum</span>(k, <span class="st">'*'</span>, i) <span class="op">==</span> outflow[k, i] <span class="cf">for</span> k <span class="kw">in</span> commodities <span class="cf">for</span> i <span class="kw">in</span> nodes), <span class="st">"node"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>master.setObjective(excess, GRB.MINIMIZE)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>sub.setObjective(quicksum(<span class="dv">0</span><span class="op">*</span>x[k,i,j]<span class="op">-</span><span class="dv">1</span> <span class="cf">for</span> k <span class="kw">in</span> commodities <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs), GRB.MINIMIZE)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>nprop <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>prop_cost <span class="op">=</span> <span class="bu">dict</span>({})</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>prop_ship <span class="op">=</span> <span class="bu">dict</span>({})</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>master.Params.OutputFlag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>sub.Params.OutputFlag <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    sub.optimize()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sub.objVal <span class="op">&gt;=</span> <span class="op">-</span><span class="fl">1e-5</span>:</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'NO FEABIEL SOLUTION'</span>)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    prop_cost[nprop] <span class="op">=</span> <span class="bu">sum</span>(cost[k,i,j]<span class="op">*</span>x[k,i,j].x <span class="cf">for</span> k <span class="kw">in</span> commodities <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    prop_ship[nprop] <span class="op">=</span> <span class="bu">dict</span>([((i,j),<span class="bu">sum</span>(x[k,i,j].x <span class="cf">for</span> k <span class="kw">in</span> commodities)) <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs])</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(prop_ship)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    master.update() <span class="co"># must update otherwise master.getConstrs() gets empty</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    master.addVar(vtype<span class="op">=</span>GRB.CONTINUOUS, name<span class="op">=</span><span class="st">'l['</span><span class="op">+</span><span class="bu">str</span>(nprop)<span class="op">+</span><span class="st">']'</span>,</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>                  column<span class="op">=</span>Column([<span class="op">*</span>prop_ship[nprop].values(),<span class="dv">1</span>], master.getConstrs()))</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    master.optimize()</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    nprop <span class="op">=</span> nprop<span class="op">+</span><span class="dv">1</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> master.objVal <span class="op">&lt;=</span> <span class="fl">1e-5</span>:</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> <span class="bu">dict</span>([((i,j),master.getConstrByName(<span class="ss">f"multi[</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">]"</span>).Pi) <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs])</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> master.getConstrByName(<span class="ss">f"convex"</span>).Pi</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        sub.setObjective(quicksum((<span class="op">-</span>v[i,j])<span class="op">*</span>x[k,i,j] <span class="cf">for</span> k <span class="kw">in</span> commodities <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs) <span class="op">-</span> </span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>                         <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> k <span class="kw">in</span> commodities), GRB.MINIMIZE)</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(v,w)        </span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>master.Params.OutputFlag <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>sub.Params.OutputFlag <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>excess.lb <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>excess.ub <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>master.setObjective(quicksum(prop_cost[t]<span class="op">*</span>master.getVarByName(<span class="ss">f"l[</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">]"</span>) <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(nprop)), GRB.MINIMIZE)</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>master.update()</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    sub.setObjective(quicksum((cost[k,i,j]<span class="op">-</span>v[i,j])<span class="op">*</span>x[k,i,j] <span class="cf">for</span> k <span class="kw">in</span> commodities <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs) <span class="op">-</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>                     <span class="bu">sum</span>(w <span class="cf">for</span> k <span class="kw">in</span> commodities), GRB.MINIMIZE)</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    sub.optimize()</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sub.objVal <span class="op">&gt;=</span> <span class="op">-</span><span class="fl">1e-5</span>:</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'OPTIMAL SOLUTION'</span>)</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    prop_cost[nprop] <span class="op">=</span> <span class="bu">sum</span>(cost[k,i,j]<span class="op">*</span>x[k,i,j].x <span class="cf">for</span> k <span class="kw">in</span> commodities <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs)</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    prop_ship[nprop] <span class="op">=</span> <span class="bu">dict</span>([((i,j),<span class="bu">sum</span>(x[k,i,j].x <span class="cf">for</span> k <span class="kw">in</span> commodities)) <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs])</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    master.update() <span class="co"># must update otherwise master.getConstrs() gets empty</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    master.addVar(vtype<span class="op">=</span>GRB.CONTINUOUS,  name<span class="op">=</span><span class="st">'l['</span><span class="op">+</span><span class="bu">str</span>(nprop)<span class="op">+</span><span class="st">']'</span>, obj<span class="op">=</span>prop_cost[nprop],</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>                  column<span class="op">=</span>Column([<span class="op">*</span>prop_ship[nprop].values(),<span class="dv">1</span>], master.getConstrs()))</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    master.optimize()</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    nprop <span class="op">=</span> nprop<span class="op">+</span><span class="dv">1</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> <span class="bu">dict</span>([((i,j),master.getConstrByName(<span class="ss">f"multi[</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">,</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">]"</span>).Pi) <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs])</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> master.getConstrByName(<span class="ss">f"convex"</span>).Pi</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>opt_ship <span class="op">=</span> <span class="bu">dict</span>([((i,j), <span class="bu">sum</span>(prop_ship[t][i,j]<span class="op">*</span>master.getVarByName(<span class="ss">f"l[</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">]"</span>).x <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(nprop))) <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs])</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a><span class="co"># opt_ship</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>{0: {(1, 2): 10.0, (1, 3): 0.0, (5, 3): 0.0, (5, 6): 20.0, (3, 4): 0.0, (4, 2): 0.0, (4, 6): 0.0}}
{0: {(1, 2): 10.0, (1, 3): 0.0, (5, 3): 0.0, (5, 6): 20.0, (3, 4): 0.0, (4, 2): 0.0, (4, 6): 0.0}, 1: {(1, 2): 0.0, (1, 3): 10.0, (5, 3): 0.0, (5, 6): 20.0, (3, 4): 10.0, (4, 2): 10.0, (4, 6): 0.0}}
{(1, 2): -1.0, (1, 3): 0.0, (5, 3): 0.0, (5, 6): 0.0, (3, 4): 0.0, (4, 2): 0.0, (4, 6): 0.0} 10.0
Set parameter OutputFlag to value 1
Set parameter OutputFlag to value 1
Gurobi Optimizer version 9.5.2 build v9.5.2rc0 (win64)
Thread count: 8 physical cores, 16 logical processors, using up to 16 threads
Optimize a model with 12 rows, 14 columns and 28 nonzeros
Coefficient statistics:
  Matrix range     [1e+00, 1e+00]
  Objective range  [1e+00, 5e+00]
  Bounds range     [0e+00, 0e+00]
  RHS range        [1e+01, 2e+01]
Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0   -1.1000000e+31   4.000000e+30   1.100000e+01      0s
       2    6.0000000e+01   0.000000e+00   0.000000e+00      0s

Solved in 2 iterations and 0.00 seconds (0.00 work units)
Optimal objective  6.000000000e+01
OPTIMAL SOLUTION
Gurobi Optimizer version 9.5.2 build v9.5.2rc0 (win64)
Thread count: 8 physical cores, 16 logical processors, using up to 16 threads
Optimize a model with 8 rows, 4 columns and 20 nonzeros
Coefficient statistics:
  Matrix range     [1e+00, 2e+01]
  Objective range  [7e+01, 2e+02]
  Bounds range     [0e+00, 0e+00]
  RHS range        [1e+00, 3e+01]
Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0   -6.0000000e+31   4.500000e+30   6.000000e+01      0s
       3    1.5000000e+02   0.000000e+00   0.000000e+00      0s

Solved in 3 iterations and 0.00 seconds (0.00 work units)
Optimal objective  1.500000000e+02
Gurobi Optimizer version 9.5.2 build v9.5.2rc0 (win64)
Thread count: 8 physical cores, 16 logical processors, using up to 16 threads
Optimize a model with 12 rows, 14 columns and 28 nonzeros
Coefficient statistics:
  Matrix range     [1e+00, 1e+00]
  Objective range  [1e+00, 1e+01]
  Bounds range     [0e+00, 0e+00]
  RHS range        [1e+01, 2e+01]
Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0   -2.3000000e+02   0.000000e+00   0.000000e+00      0s

Solved in 0 iterations and 0.00 seconds (0.00 work units)
Optimal objective -2.300000000e+02</code></pre>
</div>
</div>
<div class="cell" data-execution_count="56">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> Model()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> m.addVars(commodities, arcs, vtype<span class="op">=</span>GRB.CONTINUOUS, name<span class="op">=</span><span class="st">"flow"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>m.setObjective(quicksum(cost[k,i,j]<span class="op">*</span>x[k,i,j] <span class="cf">for</span> k <span class="kw">in</span> commodities <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs), GRB.MINIMIZE)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>m.addConstrs((x.<span class="bu">sum</span>(k, i, <span class="st">'*'</span>) <span class="op">-</span> x.<span class="bu">sum</span>(k, <span class="st">'*'</span>, i) <span class="op">==</span> outflow[k, i] <span class="cf">for</span> k <span class="kw">in</span> commodities <span class="cf">for</span> i <span class="kw">in</span> nodes), <span class="st">"node"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>m.addConstrs(quicksum(x[k,i,j] <span class="cf">for</span> k <span class="kw">in</span> commodities) <span class="op">==</span> opt_ship[i,j] <span class="cf">for</span> (i,j) <span class="kw">in</span> arcs)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>m.optimize()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Gurobi Optimizer version 9.5.2 build v9.5.2rc0 (win64)
Thread count: 8 physical cores, 16 logical processors, using up to 16 threads
Optimize a model with 19 rows, 14 columns and 42 nonzeros
Model fingerprint: 0xd534693b
Coefficient statistics:
  Matrix range     [1e+00, 1e+00]
  Objective range  [1e+00, 5e+00]
  Bounds range     [0e+00, 0e+00]
  RHS range        [5e+00, 2e+01]
Presolve removed 19 rows and 14 columns
Presolve time: 0.00s
Presolve: All rows and columns removed
Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0    1.5000000e+02   0.000000e+00   0.000000e+00      0s

Solved in 0 iterations and 0.00 seconds (0.00 work units)
Optimal objective  1.500000000e+02</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>{(1, 1, 2): &lt;gurobi.Var flow[1,1,2] (value 5.0)&gt;,
 (1, 1, 3): &lt;gurobi.Var flow[1,1,3] (value 5.0)&gt;,
 (1, 5, 3): &lt;gurobi.Var flow[1,5,3] (value 0.0)&gt;,
 (1, 5, 6): &lt;gurobi.Var flow[1,5,6] (value 0.0)&gt;,
 (1, 3, 4): &lt;gurobi.Var flow[1,3,4] (value 5.0)&gt;,
 (1, 4, 2): &lt;gurobi.Var flow[1,4,2] (value 5.0)&gt;,
 (1, 4, 6): &lt;gurobi.Var flow[1,4,6] (value 0.0)&gt;,
 (2, 1, 2): &lt;gurobi.Var flow[2,1,2] (value 0.0)&gt;,
 (2, 1, 3): &lt;gurobi.Var flow[2,1,3] (value 0.0)&gt;,
 (2, 5, 3): &lt;gurobi.Var flow[2,5,3] (value 5.0)&gt;,
 (2, 5, 6): &lt;gurobi.Var flow[2,5,6] (value 15.0)&gt;,
 (2, 3, 4): &lt;gurobi.Var flow[2,3,4] (value 5.0)&gt;,
 (2, 4, 2): &lt;gurobi.Var flow[2,4,2] (value 0.0)&gt;,
 (2, 4, 6): &lt;gurobi.Var flow[2,4,6] (value 5.0)&gt;}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="48">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sub.display()</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># sub.getVars()</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>master.display()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>master.getVars()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Minimize
  &lt;gurobi.LinExpr: 110.0 l[0] + 210.0 l[1] + 70.0 l[2]&gt;
Subject To
  multi[1,2]: &lt;gurobi.LinExpr: -1.0 C0 + 10.0 l[0] + 10.0 l[2]&gt; &lt;= 5
  multi[1,3]: &lt;gurobi.LinExpr: -1.0 C0 + 10.0 l[1]&gt; &lt;= 30
  multi[5,3]: &lt;gurobi.LinExpr: -1.0 C0 + 20.0 l[2]&gt; &lt;= 30
  multi[5,6]: &lt;gurobi.LinExpr: -1.0 C0 + 20.0 l[0] + 20.0 l[1]&gt; &lt;= 30
  multi[3,4]: &lt;gurobi.LinExpr: -1.0 C0 + 10.0 l[1] + 20.0 l[2]&gt; &lt;= 10
  multi[4,2]: &lt;gurobi.LinExpr: -1.0 C0 + 10.0 l[1]&gt; &lt;= 30
  multi[4,6]: &lt;gurobi.LinExpr: -1.0 C0 + 20.0 l[2]&gt; &lt;= 30
  convex: &lt;gurobi.LinExpr: l[0] + l[1] + l[2]&gt; = 1
Bounds
  C0 = 0</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>[&lt;gurobi.Var C0 (value 0.0)&gt;,
 &lt;gurobi.Var l[0] (value 0.25)&gt;,
 &lt;gurobi.Var l[1] (value 0.5)&gt;,
 &lt;gurobi.Var l[2] (value 0.25)&gt;]</code></pre>
</div>
</div>
</section>
</section>
<section id="gap" class="level1">
<h1>GAP</h1>
<p><span class="math display">\begin{align*}
&amp;\text{maximize} &amp;\sum_{1 \le i \le m} \sum_{1 \le j \le n} f_{ij} x_{ij} \\
&amp;\text{subject to} &amp;\sum_{1 \le i \le m} x_{ij} &amp; = 1 &amp;&amp; j = 1 \ldots n \\
&amp;&amp;\sum_{1 \le j \le n} w_{ij} x_{ij} &amp;\le c_i &amp;&amp; i = 1 \ldots m \\
&amp;&amp; x_{ij} &amp; \in \{0,1\} &amp;&amp; i = 1 \ldots m; j = 1 \ldots n
\end{align*}</span></p>
<ul>
<li><p><span class="math inline">x^i_p = (x^i_{1p},\ldots, x^i_{np})</span>: a solution to agent <span class="math inline">i</span> such that</p>
<ul>
<li><p><span class="math inline">x^i_{jp}=1</span>: agent <span class="math inline">i</span> is assigned to job <span class="math inline">j</span> in the <span class="math inline">p</span>th (this) solution</p></li>
<li><p><span class="math inline">x^i_{jp}=0</span> otherwise;</p></li>
</ul></li>
<li><p><span class="math inline">P_i = \{x^i_1, \ldots, x^i_{p_i}\}</span>: set of all possible feasible assignments for agent <span class="math inline">i</span>;</p></li>
<li><p><span class="math inline">\lambda^i_p \in \color{red}{\{0,1\}}</span>: whether a feasible assignment <span class="math inline">x^i_p</span> is selected;</p></li>
<li><p><span class="math inline">x_{ij} = \sum_{1 \le p \le p_i} x^i_{jp} \lambda^i_p</span>.</p></li>
</ul>
<p><span class="math display">\begin{align*}
&amp;\text{maximize} &amp;\sum_{1 \le i \le m} \sum_{1 \le p \le p_i} \left( \sum_{1 \le j \le n} f_{ij} x^i_{jp} \right) \lambda^i_p\\
&amp;\text{subject to} &amp;\sum_{1 \le i \le m} \sum_{1 \le p \le p_i} x^i_{jp} \lambda^i_p &amp; = 1 &amp;&amp; j = 1 \ldots n \\
&amp;&amp;\sum_{1 \le p \le p_i} \lambda^i_{p} &amp;\le 1 &amp;&amp; i = 1 \ldots m \\
&amp;&amp; \lambda^i_{p} &amp; \in \{0,1\} &amp;&amp; i = 1 \ldots m; p \in P_i
\end{align*}</span></p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>